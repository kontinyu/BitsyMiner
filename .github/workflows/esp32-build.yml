name: ESP32 Dev Module Build (multi-variant)

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        variant: [2432S024, 2432S028_9341, 2432S028_ST7789, headless]
        include:
          - variant: 2432S024
            defines: "-DESP32_2432S024"
            outname: 2.4inch_9341

          - variant: 2432S028_9341
            defines: "-DESP32_2432S028"
            outname: 2.8inch_9341

          - variant: 2432S028_ST7789
            defines: "-DESP32_2432S028 -DST7789_LCD"
            outname: 2.8inch_ST7789

          - variant: headless
            defines: "-DESP32_DEV_HEADLESS"
            outname: headless

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Arduino CLI
        uses: arduino/setup-arduino-cli@v2
        with:
          version: 1.4.x

      - name: Configure Arduino CLI & install ESP32 core
        run: |
          arduino-cli config init --overwrite
          arduino-cli config set board_manager.additional_urls https://espressif.github.io/arduino-esp32/package_esp32_index.json
          arduino-cli core update-index
          arduino-cli core install esp32:esp32@3.3.3

      - name: Install required libraries
        run: |
          arduino-cli lib install "ArduinoJson"
          arduino-cli lib install "NTPClient"
          arduino-cli lib install "XPT2046_Touchscreen"
          arduino-cli lib install "CustomJWT"
          arduino-cli lib install "PNGdec"
          arduino-cli lib install "TFT_eSPI"

      - name: Apply custom TFT_eSPI setup
        run: |
          # locate the installed library
          TFT_LIB=$(arduino-cli lib list | grep '^TFT_eSPI ' | awk '{print $3}')
          echo "Using TFT_eSPI path: $TFT_LIB"        
          
          # copy your User_Setup.h
          cp TFT_eSPI/*.h $TFT_LIB
          
          # optionally copy extra fonts or extras
          mkdir -p $TFT_LIB/TFT_Drivers
          cp -r TFT_eSPI/TFT_Drivers/* $TFT_LIB/TFT_Drivers/
          
          
      - name: Compile BitsyMinerOpenSource (${{ matrix.outname }})
        run: |
          mkdir -p build/${{ matrix.variant }}

          arduino-cli compile \
            --libraries ./libraries \
            --fqbn esp32:esp32:esp32:PartitionScheme=min_spiffs \
            --build-property build.extra_flags="${{ matrix.defines }} -DARDUINO_RUNNING_CORE=0 -DARDUINO_EVENT_RUNNING_CORE=0" \
            --output-dir build/${{ matrix.variant }} \
            BitsyMinerOpenSource


      - name: Upload firmware binary (${{ matrix.outname }})
        uses: actions/upload-artifact@v4
        with:
          name: BitsyMinerOpenSource-${{ matrix.outname }}
          path: build/${{ matrix.variant }}/**/*.bin
